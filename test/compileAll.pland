

var fs = require "fs";


var callback = new Callback();

fs.readdir(".", callback);

var files = (*callback.promise)[1];



if (files){
  for (var i = 0; i < files.length; ++i){
    callback = new Callback();
    var filename = files[i];
    
    
    if (filename.substr( filename.length - 6 ) == ".pland"){
      console.log("processing:" + filename);
      try{
        fs.readFile(filename, {
              encoding: "utf8"
            }, callback.callback);
        var codeStr = (*callback.promise)[1];
        var parser = new promiseland.Parser();
        console.log("step0");

        var jsStr = (*parser.parse(codeStr)).javascript;
        console.log("step2");

        callback = new Callback();
        fs.writeFile(filename.substr(0, filename.length - 6 ) + ".js", jsStr, callback.callback);
        *callback.promise;
        console.log("done");
      }catch(e){
        console.log(e);
        console.log("error");
      };
    };
  };
};
