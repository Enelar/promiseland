

var fs = require "fs";


var callback = new Callback();

fs.readdir(".", callback);

var files = (*callback.promise)[1];



if (files){
  for (var i = 0; i < files.length; ++i){
    callback = new Callback();
    var filename = files[i];
    
    
    if (filename.substr( filename.length - 6 ) == ".pland"){
      console.log("processing:" + filename);
      var jsStr = "";
      try{
        fs.readFile(filename, {
              encoding: "utf8"
            }, callback.callback);
        var codeStr = (*callback.promise)[1];
        var parser = new promiseland.Parser();

        
        var res = (*parser.parse(codeStr));
        if (res.errors && res.errors.length){
          console.log(res.errors[0]);
          jsStr = "";
        }else{
          jsStr = res.javascript;
        };
        
      }catch(e){
        console.log(e);
        console.log("error");
        
      };
      
      callback = new Callback();
      fs.writeFile(filename.substr(0, filename.length - 6 ) + ".js", jsStr, callback.callback);
      *callback.promise;
    };
  };
};
